## VectorChord 源码学习: 1.1 快速入门指南 (Quick Start Guide)  
  
### 作者  
digoal  
  
### 日期  
2025-10-30  
  
### 标签  
VectorChord , 源码学习  
  
----  
  
## 背景  
本文提供使用 **Docker** 部署 **VectorChord** 并执行基本**向量相似性搜索 (vector similarity search)** 操作的**分步说明 (step-by-step instructions)**。涵盖了**安装 (installation)**、**创建您的第一个向量表 (creating your first vector table)**、**构建索引 (building indexes)** 和**执行查询 (executing queries)**。  
  
## Docker 部署 (Docker Deployment)  
  
开始使用 VectorChord 的**推荐方法 (recommended way)** 是使用**预构建的 Docker 镜像 (pre-built Docker image)**，其中包含安装了 **VectorChord 扩展 (VectorChord extension)** 的 **PostgreSQL**。  
  
### 启动容器 (Starting the Container)  
  
```bash  
docker run \  
  --name vectorchord-demo \  
  -e POSTGRES_PASSWORD=mysecretpassword \  
  -p 5432:5432 \  
  -d ghcr.io/tensorchord/vchord-postgres:pg18-v0.5.3  
```  
  
### 连接到数据库 (Connecting to the Database)  
  
默认用户名为 `postgres`，密码通过 `POSTGRES_PASSWORD` **环境变量 (environment variable)** 设置。  
  
```bash  
psql -h localhost -p 5432 -U postgres  
```  
  
**VectorChord 扩展架构 (VectorChord Extension Architecture)**  
  
![pic](20251030_08_pic_001.jpg)  
  
来源:  
- [`README.md` 65-79](https://github.com/tensorchord/VectorChord/blob/ac12e257/README.md#L65-L79)  
  
## 基本向量操作 (Basic Vector Operations)  
  
### 创建扩展 (Creating the Extension)  
  
启用 **VectorChord 扩展 (VectorChord extension)**，它会自动包含 **pgvector** 作为**依赖项 (dependency)**：  
  
```sql  
CREATE EXTENSION IF NOT EXISTS vchord CASCADE;  
```  
  
### 创建向量表 (Creating a Vector Table)  
  
创建一个带有**向量列 (vector column)** 的表。`vector(3)` **类型 (type)** 指定了 **3 维向量 (3-dimensional vectors)**：  
  
```sql  
CREATE TABLE items (id bigserial PRIMARY KEY, embedding vector(3));  
```  
  
### 插入样本数据 (Inserting Sample Data)  
  
生成**随机向量 (random vectors)** 用于测试：  
  
```sql  
INSERT INTO items (embedding)   
SELECT ARRAY[random(), random(), random()]::real[]   
FROM generate_series(1, 1000);  
```  
  
**向量数据流 (Vector Data Flow)**  
  
![pic](20251030_08_pic_002.jpg)  
  
来源:  
- [`README.md` 89-94](https://github.com/tensorchord/VectorChord/blob/ac12e257/README.md#L89-L94)  
- [`sql/install/vchord--0.2.1.sql` 313-323](https://github.com/tensorchord/VectorChord/blob/ac12e257/sql/install/vchord--0.2.1.sql#L313-L323)  
  
## 索引创建与搜索 (Index Creation and Search)  
  
### 创建向量索引 (Creating a Vector Index)  
  
构建一个 `vchordrq`（**残差量化 (residual quantization)**）**索引 (index)** 用于**快速相似性搜索 (fast similarity search)**：  
  
```sql  
CREATE INDEX ON items USING vchordrq (embedding vector_l2_ops);  
```  
  
### 执行向量搜索 (Performing Vector Search)  
  
使用 **L2 距离运算符 (L2 distance operator)** `<->` 执行 **k-最近邻 (k-nearest neighbor)** 搜索：  
  
```sql  
SELECT * FROM items ORDER BY embedding <-> '[3,1,2]' LIMIT 5;  
```  
  
**索引与搜索架构 (Index and Search Architecture)**  
  
![pic](20251030_08_pic_003.jpg)  
  
来源:  
- [`README.md` 96-106](https://github.com/tensorchord/VectorChord/blob/ac12e257/README.md#L96-L106)  
- [`sql/install/vchord--0.2.1.sql` 443-451](https://github.com/tensorchord/VectorChord/blob/ac12e257/sql/install/vchord--0.2.1.sql#L443-L451)  
  
## 可用的距离指标 (Available Distance Metrics)  
  
VectorChord 通过不同的**运算符 (operators)** 支持**多种距离指标 (multiple distance metrics)**：  
  
| 运算符 (Operator) | 距离指标 (Distance Metric) | 运算符类 (Operator Class) | 描述 (Description) |  
| :--- | :--- | :--- | :--- |  
| `<->` | **L2 (欧几里得) (L2 (Euclidean))** | `vector_l2_ops` | 标准欧几里得距离 (Standard Euclidean distance) |  
| `<#>` | **内积 (Inner Product)** | `vector_ip_ops` | 负内积 (Negative inner product) |  
| `<=>` | **余弦 (Cosine)** | `vector_cosine_ops` | 余弦距离 (Cosine distance) (1 - 余弦相似性 (cosine similarity)) |  
  
### 示例查询 (Example Queries)  
  
```sql  
-- L2 distance  
SELECT * FROM items ORDER BY embedding <-> '[1,2,3]' LIMIT 5;  
  
-- Inner product (for normalized vectors)  
SELECT * FROM items ORDER BY embedding <#> '[1,2,3]' LIMIT 5;  
  
-- Cosine distance  
SELECT * FROM items ORDER BY embedding <=> '[1,2,3]' LIMIT 5;  
```  
  
来源:  
- [`sql/install/vchord--0.2.1.sql` 464-480](https://github.com/tensorchord/VectorChord/blob/ac12e257/sql/install/vchord--0.2.1.sql#L464-L480)  
  
## 数据类型与量化 (Data Types and Quantization)  
  
VectorChord 扩展了 **pgvector**，增加了额外的**数据类型 (data types)**：  
  
### 向量类型 (Vector Types)  
  
* `vector(n)` - **标准浮点向量 (Standard floating-point vectors)** (pgvector)  
* `halfvec(n)` - **半精度浮点向量 (Half-precision floating-point vectors)**  
* `scalar8(n)` - **8 位量化向量 (8-bit quantized vectors)**  
  
### 量化函数 (Quantization Functions)  
  
将向量转换为**更高效的存储格式 (more efficient storage formats)**：  
  
```sql  
-- Quantize vector to 8-bit representation  
SELECT quantize_to_scalar8('[1.5, 2.7, 0.3]'::vector);  
```  
  
**数据类型层次结构 (Data Type Hierarchy)**  
  
![pic](20251030_08_pic_004.jpg)  
  
来源:  
- [`sql/install/vchord--0.2.1.sql` 437-441](https://github.com/tensorchord/VectorChord/blob/ac12e257/sql/install/vchord--0.2.1.sql#L437-L441)  
- [`sql/install/vchord--0.2.1.sql` 325-338](https://github.com/tensorchord/VectorChord/blob/ac12e257/sql/install/vchord--0.2.1.sql#L325-L338)  
  
## 外部数据处理工具 (External Data Processing Tools)  
  
VectorChord 包含用于**高级数据处理工作流程 (advanced data processing workflows)** 的 **Python 脚本 (Python scripts)**：  
  
### 数据导出与导入 (Data Export and Import)  
  
```bash  
# Export existing vectors from PostgreSQL  
python scripts/dump.py -n table_name -c column_name -d 768 -o export.hdf5  
  
# Train k-means centroids  
python scripts/train.py -i dataset.hdf5 -o centroids.npy -lists 1000 -m l2  
  
# Import data and build index  
python scripts/index.py -n table_name -i dataset.hdf5 -c centroids.npy -m l2 -d 768 --url postgresql://postgres:123@localhost:5432/postgres  
```  
  
### 基准测试 (Benchmarking)  
  
```bash  
# Performance evaluation  
python scripts/bench.py -n table_name -i dataset.hdf5 -m l2 --nprob 100 --epsilon 1.0 --url postgresql://postgres:123@localhost:5432/postgres  
```  
  
**外部管道架构 (External Pipeline Architecture)**  
  
![pic](20251030_08_pic_005.jpg)  
  
来源:  
- [`scripts/README.md` 1-58](https://github.com/tensorchord/VectorChord/blob/ac12e257/scripts/README.md#L1-L58)  
- [`scripts/index.py` 77-116](https://github.com/tensorchord/VectorChord/blob/ac12e257/scripts/index.py#L77-L116)  
- [`scripts/bench.py` 27-55](https://github.com/tensorchord/VectorChord/blob/ac12e257/scripts/bench.py#L27-L55)  
    
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
