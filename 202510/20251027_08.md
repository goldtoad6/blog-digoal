## PostgreSQL 19 preview - pg_rewind patch 2连发, 优化WAL拷贝量       
                            
### 作者                            
digoal                            
                            
### 日期                            
2025-10-27                           
                            
### 标签                            
PostgreSQL , PolarDB , DuckDB , pg_rewind , wal , WAL名字识别 , 分歧点后WAL                
                            
----                            
                            
## 背景    
pg_rewind大家都知道, 通常用来解决PG在异步HA环境下, 主从发生切换后, 老主库变成新从库之前, 要做的一系列回退操作.    
  
例如老的主库有几MB的WAL没有同步到从库, 从库就激活了, 开始读写.  
  
具体流程可参考此文： [《PostgreSQL 9.5 new feature - pg_rewind fast sync Split Brain Primary & Standby》](../201503/20150325_02.md)    
  
PG 19 最近发了2个 pg_rewind 相关的 patch, 目的是优化WAL拷贝量.     
- https://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=6ae08d9583e9a5e951286948bdd9fcd58e67718a  
- https://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=5173bfd0443e0c0f3fa37006727d516dc1ba4cee  
  
```  
pg_rewind: Extend code detecting relation files to work with WAL files  
author	Michael Paquier <michael@paquier.xyz>	  
Thu, 23 Oct 2025 06:57:46 +0000 (15:57 +0900)  
committer	Michael Paquier <michael@paquier.xyz>	  
Thu, 23 Oct 2025 06:57:46 +0000 (15:57 +0900)  
commit	6ae08d9583e9a5e951286948bdd9fcd58e67718a  
tree	c0ae8f924e923da5d5cb4bb67109201006d0d957	tree  
parent	abc2b71383b4c49c2fbda74c281d50f3936551b8	commit | diff  
pg_rewind: Extend code detecting relation files to work with WAL files  
  
isRelDataFile() is renamed to getFileContentType(), extended so as it  
becomes able to detect more file patterns than only relation files.  The  
new file name pattern that can be detected is WAL files.  
  
This refactoring has been suggested by Robert Haas.  This will be used  
in a follow-up patch where we are looking at improving how WAL files are  
processed by pg_rewind.  As of this change, WAL files are still handled  
the same way as previously, always copied from the source to the target  
server.  
  
Extracted from a larger patch by the same authors.  
  
Author: John Hsu <johnhyvr@gmail.com>  
Author: Justin Kwan <justinpkwan@outlook.com>  
Reviewed-by: Japin Li <japinli@hotmail.com>  
Reviewed-by: Srinath Reddy Sadipiralla <srinath2133@gmail.com>  
Discussion: https://postgr.es/m/181b4c6fa9c.b8b725681941212.7547232617810891479@viggy28.dev  
```  
  
```  
pg_rewind: Skip copy of WAL segments generated before point of divergence  
author	Michael Paquier <michael@paquier.xyz>	  
Sat, 25 Oct 2025 00:07:31 +0000 (09:07 +0900)  
committer	Michael Paquier <michael@paquier.xyz>	  
Sat, 25 Oct 2025 00:07:31 +0000 (09:07 +0900)  
commit	5173bfd0443e0c0f3fa37006727d516dc1ba4cee  
tree	db570500673c70d6608c5bcd806c3a75d52cba21	tree  
parent	14ee8e6403001c3788f2622cdcf81a8451502dc2	commit | diff  
pg_rewind: Skip copy of WAL segments generated before point of divergence  
  
This commit makes the way WAL segments are handled from the source to  
the target server slightly smarter: the copy of the WAL segments is now  
skipped if these have been created before the point where source and  
target have diverged (the WAL segment where the point of divergence  
exists is still copied), because we know that such segments exist on  
both the target and source.  Note that the on-disk size of the WAL  
segments on the source and target need to match.  Hence, only the  
segments generated after the point of divergence are now copied.  A  
segment existing on the source but not the target is copied.  
  
Previously, all the WAL segments were just copied in full.  This change  
can make the rewind operation cheaper in some configurations, especially  
for setups where some WAL retention causes many segments to remain on  
the source server even after the promotion of a standby used as source  
to rewind a previous primary.  
  
A TAP test is added to track these new behaviors.  The file map printed  
with --debug now includes all the information related to WAL segments,  
to be able to track if these are copied or skipped, and the test relies  
on the debug output generated.  
  
Author: John Hsu <johnhyvr@gmail.com>  
Author: Justin Kwan <justinpkwan@outlook.com>  
Reviewed-by: Robert Haas <robertmhaas@gmail.com>  
Reviewed-by: Alexander Korotkov <aekorotkov@gmail.com>  
Reviewed-by: Japin Li <japinli@hotmail.com>  
Reviewed-by: Michael Paquier <michael@paquier.xyz>  
Reviewed-by: Srinath Reddy Sadipiralla <srinath2133@gmail.com>  
Discussion: https://postgr.es/m/181b4c6fa9c.b8b725681941212.7547232617810891479@viggy28.dev  
```  
  
看看Qwen3的解读!  
  
Patch 核心目的是 **优化 `pg_rewind` 工具在执行时对 WAL（Write-Ahead Logging）段文件的处理逻辑**，从而减少不必要的 I/O 和网络传输开销。  
  
### 背景知识简要回顾  
  
`pg_rewind` 是 PostgreSQL 提供的一个工具，用于将一个旧的主节点（或另一个副本）快速“回退”到与新的主节点一致的状态，而无需重新做一次完整的基础备份（base backup）。它通过比较两个实例的数据块差异，并只同步必要的部分来实现高效同步。  
  
在 `pg_rewind` 运行过程中，除了数据文件，还需要处理 **WAL 段文件**，因为目标实例可能需要这些 WAL 来重放事务、达到一致状态。  
  
### Patch 做了什么？  
  
#### ✅ **核心改进：跳过复制“分歧点之前”生成的 WAL 段**  
  
- 在 `pg_rewind` 中，会先确定 **source（源）和 target（目标）两个实例的“分歧点”（point of divergence）** —— 即它们最后一次拥有相同 WAL 位置的时间点。  
- **旧逻辑**：无论 WAL 段是在分歧点之前还是之后生成的，只要在 source 上存在，就全部复制到 target。  
- **新逻辑**：  
  - **跳过**那些 **在分歧点之前生成的 WAL 段**（因为 target 上本来就有，内容也相同）。  
  - **仍然复制**：  
    - 分歧点所在的那个 WAL 段（可能部分重叠，需要保留）；  
    - 所有 **在分歧点之后生成的 WAL 段**（target 缺失，必须复制）；  
    - 以及 **source 有但 target 完全没有的段**（即使时间早，也可能因清理策略缺失，仍需复制）。  
  
> ⚠️ 但有一个前提条件：**只有当 source 和 target 上同名 WAL 段的磁盘大小完全一致时，才认为它们“相同”，可以安全跳过。**  
  
这是为了防止因 WAL 段被截断、损坏或部分写入而导致误判。  
  
### 为什么这个优化有意义？  
  
在某些部署场景中：  
  
- 源服务器（比如刚被提升为主库的原 standby）可能保留了大量历史 WAL（例如通过 `wal_keep_size`、归档或复制槽）；  
- 而目标服务器（比如旧主库）虽然也有部分 WAL，但可能因崩溃或切换丢失了最新部分；  
- 如果 `pg_rewind` 仍盲目复制所有 WAL，就会浪费大量时间和带宽去复制 **双方其实都有的旧 WAL**。  
  
**优化后**：只复制真正需要的 WAL（分歧点及之后），显著降低 `pg_rewind` 的资源消耗和运行时间。  
  
### 其他配套改动  
  
1. **新增 TAP 测试**    
   专门验证新行为是否正确：确保“早于分歧点的 WAL 被跳过”，“之后的被复制”。  
  
2. **增强 `--debug` 输出**    
   在调试模式下，`pg_rewind` 现在会打印完整的 WAL 段处理清单，标明哪些被复制、哪些被跳过，便于测试和排查。  
  
这个 patch 是一个典型的 **“聪明一点，少做无用功”** 的性能优化，体现了 PostgreSQL 社区对工具链细节的持续打磨。  
       
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
